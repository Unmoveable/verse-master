<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Verse Master v4.18</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        /* Custom Theme Classes */
        .theme-light { --bg-color: #f3f4f6; --text-color: #1f2937; --card-bg: #ffffff; --accent: #3b82f6; --dim: #9ca3af; --input-bg: #ffffff; --input-border: #e5e7eb; --btn-bg: #d1d5db; --btn-hover: #9ca3af; }
        .theme-dark { --bg-color: #09090b; --text-color: #f4f4f5; --card-bg: #18181b; --accent: #60a5fa; --dim: #a1a1aa; --input-bg: #27272a; --input-border: #3f3f46; --btn-bg: #27272a; --btn-hover: #3f3f46; }
        .theme-midnight { --bg-color: #0f172a; --text-color: #e2e8f0; --card-bg: #1e293b; --accent: #38bdf8; --dim: #64748b; --input-bg: #334155; --input-border: #475569; --btn-bg: #334155; --btn-hover: #475569; }
        .theme-crimson { --bg-color: #2b0a0a; --text-color: #fecaca; --card-bg: #450a0a; --accent: #f87171; --dim: #991b1b; --input-bg: #450a0a; --input-border: #7f1d1d; --btn-bg: #591111; --btn-hover: #7f1d1d; }

        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; overflow: hidden; }
        .verse-font { font-family: 'Lora', serif; }
        .card { background-color: var(--card-bg); transition: background-color 0.3s; }
        .text-accent { color: var(--accent); }
        .bg-accent { background-color: var(--accent); }
        .text-dim { color: var(--dim); }
        .input-field { background-color: var(--input-bg); border-color: var(--input-border); color: var(--text-color); }
        .input-field::placeholder { color: var(--dim); opacity: 0.7; }
        .secondary-btn { background-color: var(--btn-bg); color: var(--text-color); transition: background-color 0.2s, transform 0.1s; }
        .secondary-btn:hover { background-color: var(--btn-hover); }
        .secondary-btn:active { transform: scale(0.95); }

        .cursor { display: inline-block; width: 2px; height: 1.2em; background-color: var(--accent); animation: blink 1s step-end infinite; vertical-align: middle; margin-left: 1px; margin-right: 1px; }
        .cursor.typing { animation: none; opacity: 1; }
        @keyframes blink { 50% { opacity: 0; } }

        .mode-memorize .remaining-text { opacity: 0.25; filter: blur(0.5px); }
        .mode-quiz .remaining-text { opacity: 1; } 
        .completed-text { color: var(--accent); opacity: 1 !important; filter: none !important; }
        .solid-blank { color: transparent !important; border-bottom: 2px solid var(--dim); display: inline-block; line-height: 0.9; margin-right: 1px; }

        .error-shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .toggle-checkbox:checked { right: 0; border-color: var(--accent); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--accent); }
        .no-select { user-select: none; -webkit-user-select: none; }
        #hidden-input { position: absolute; opacity: 0; top: -1000px; left: -1000px; font-size: 16px; width: 1px; height: 1px; }
        
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0; transform: scale(0.5); }
        @keyframes popIn { to { opacity: 1; transform: scale(1); } }

        #settings-btn svg { transition: transform 0.5s ease-in-out; }
        #settings-btn:hover svg { transform: rotate(180deg); }

        .mode-btn { transition: all 0.2s, transform 0.1s; border: 2px solid transparent; }
        .mode-btn:active { transform: scale(0.95); }
        .mode-btn.active { background-color: var(--accent); color: white; border-color: var(--accent); }
        .mode-btn.inactive { background-color: var(--btn-bg); color: var(--dim); border-color: transparent; }
        .mode-btn.inactive:hover { background-color: var(--btn-hover); }

        .loader { border: 3px solid var(--dim); border-top: 3px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .history-item { transition: background-color 0.2s; }
        .history-item:hover { background-color: var(--btn-bg); }
        .playing-audio { animation: pulse-audio 1.5s infinite; }
        @keyframes pulse-audio { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: var(--dim); border-radius: 2px; opacity: 0.3; }
        input[type=range]:focus { outline: none; }

        /* Cheat Code Styles */
        .possessed { animation: glitch-shake 0.1s infinite; cursor: none !important; }
        .fake-cursor { position: fixed; width: 20px; height: 20px; background: red; border-radius: 50%; pointer-events: none; z-index: 9999; box-shadow: 0 0 10px red; mix-blend-mode: difference; }
        @keyframes glitch-shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        /* Fire Game */
        #fire-game-layer { background: black; cursor: none; }
        .fire-emoji { position: absolute; user-select: none; animation: flicker 0.5s infinite alternate; cursor: none; }
        @keyframes flicker { from { transform: scale(1); opacity: 1; } to { transform: scale(1.1); opacity: 0.8; } }
        
        #water-gun { 
            position: absolute; 
            bottom: 10%; 
            left: 50%; 
            font-size: 4rem; 
            z-index: 100; 
            pointer-events: none; 
            transform-origin: bottom center;
            width: 1em;
            height: 1em;
            text-align: center;
            line-height: 1;
            margin-left: -0.5em;
        }
        
        .water-projectile { 
            position: absolute; 
            font-size: 1.5rem; 
            pointer-events: none; 
            z-index: 90; 
            transition: all 0.2s linear;
        }

        #bible-cursor {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            font-size: 2rem;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="theme-dark h-screen w-screen flex flex-col items-center justify-center relative">

    <!-- App Container -->
    <div id="app" class="w-full h-full max-w-4xl mx-auto flex flex-col p-4 md:p-6 relative overflow-y-auto scrollbar-hide">
        
        <!-- Top Bar -->
        <div class="flex justify-between items-start mb-4 w-full z-10 shrink-0">
            <div class="flex flex-col items-start pt-1">
                <h1 class="text-2xl font-bold tracking-tight opacity-80">VerseMaster <span class="text-xs bg-accent text-white px-1.5 py-0.5 rounded ml-1">v4.18</span></h1>
            </div>
            
            <div class="flex items-center space-x-3">
                <!-- Header Streak -->
                <div id="header-streak" class="hidden flex items-center animate-fade-in cursor-default opacity-90 hover:opacity-100 transition-opacity select-none">
                    <span class="text-lg leading-none">ðŸ”¥</span>
                    <span class="w-1"></span> 
                    <span id="header-streak-count" class="text-lg font-bold text-accent leading-none">0</span>
                </div>

                <div class="flex flex-col items-center space-y-2">
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-200/20 transition-colors focus:outline-none group" title="Settings (ESC)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                    
                    <!-- In-Game Restart Button (Stacked under settings) -->
                    <button id="game-restart-btn" onclick="restartVerse()" class="hidden p-2 rounded-full hover:bg-gray-200/20 transition-colors focus:outline-none text-dim hover:text-accent" title="Restart Verse">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Input/Setup Screen -->
        <div id="setup-screen" class="flex-1 flex flex-col items-center justify-center text-center space-y-6 fade-in w-full max-w-lg mx-auto pb-8">
            <div class="space-y-2 shrink-0">
                <h2 class="text-3xl font-bold verse-font">New Verse</h2>
                <p class="text-dim text-sm">Enter a reference</p>
            </div>
            
            <div class="w-full space-y-4">
                <div class="flex space-x-2">
                    <input type="text" id="input-ref" placeholder="e.g. John 3:16" autofocus
                        class="flex-1 p-4 rounded-xl border-2 outline-none focus:border-blue-500 transition-colors input-field text-lg font-medium shadow-sm"
                        onkeydown="if(event.key === 'Enter') startCustomGame()">
                    <button onclick="fetchVerse()" id="fetch-btn" class="secondary-btn px-3 md:px-6 rounded-xl font-semibold shadow-sm whitespace-nowrap active:scale-95 transition-transform duration-100 flex items-center justify-center min-w-[3rem] md:min-w-fit" title="Preview">
                        <span class="pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        </span>
                    </button>
                </div>

                <!-- Hide Words Slider (Independent - Quiz Only) -->
                <div id="mask-controls" class="flex items-center space-x-3 px-1 py-1 transition-opacity">
                    <span class="text-xs font-medium text-dim whitespace-nowrap w-20">Hide Words: <span id="mask-percent-display" class="text-accent">100%</span></span>
                    <input type="range" id="mask-slider" min="25" max="100" value="100" step="25" class="flex-1" oninput="updateMasking(this.value)">
                </div>

                <!-- Preview Area -->
                <div id="preview-container" class="hidden relative text-left p-4 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50 w-full break-words group">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-accent uppercase tracking-wider">Preview (KJV)</span>
                        <!-- Audio Button (Setup) - Always available in preview per convention, but restricted in game -->
                        <button onclick="toggleAudio()" class="audio-toggle-btn hidden p-1.5 rounded-full hover:bg-gray-200/50 dark:hover:bg-gray-700/50 text-dim hover:text-accent transition-colors">
                            <svg class="icon-play" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                            <svg class="icon-stop hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2" ry="2"/></svg>
                        </button>
                    </div>
                    
                    <p id="preview-text" class="verse-font text-lg leading-relaxed text-dim italic transition-all"></p>
                </div>
                
                <p id="error-msg" class="hidden text-red-500 text-sm"></p>
                
                <!-- Mode Selection -->
                <div class="grid grid-cols-2 gap-3 mt-4 w-full">
                    <button id="btn-memorize" onclick="setGameMode('memorize')" class="mode-btn active p-3 rounded-xl font-semibold shadow-sm">
                        Memorize
                    </button>
                    <button id="btn-quiz" onclick="setGameMode('quiz')" class="mode-btn inactive p-3 rounded-xl font-semibold shadow-sm">
                        Quiz
                    </button>
                </div>

                <button id="start-btn" onclick="startCustomGame()" 
                    class="w-full bg-accent text-white py-4 rounded-xl font-bold text-lg shadow-lg hover:shadow-xl hover:scale-[1.02] active:scale-[0.98] transition-all transform duration-150">
                    Start
                </button>

                <!-- History Button -->
                <button onclick="toggleHistory()" 
                    class="mt-8 w-full py-3 rounded-xl border-2 border-dashed border-gray-300 dark:border-gray-700 text-dim hover:text-accent hover:border-accent text-xs uppercase tracking-widest font-bold transition-all active:scale-95">
                    History
                </button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden flex-1 flex flex-col items-center justify-start pt-10 md:pt-20 relative max-w-3xl mx-auto w-full fade-in pb-8">
            <div class="absolute top-0 left-0 text-xs text-dim font-mono hidden md:block">
                Press 'R' to Restart | 'ESC' for Settings
            </div>

            <div class="w-full mb-8">
                <div class="flex justify-between items-end mb-2">
                    <div class="flex items-center space-x-2">
                        <span id="verse-reference" class="text-sm font-bold text-accent tracking-wide uppercase"></span>
                        <!-- Audio Button (Game) -->
                        <button onclick="toggleAudio()" id="game-audio-btn" class="audio-toggle-btn hidden p-1 rounded-full hover:bg-gray-200/50 dark:hover:bg-gray-700/50 text-dim hover:text-accent transition-colors">
                            <svg class="icon-play" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                            <svg class="icon-stop hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2" ry="2"/></svg>
                        </button>
                    </div>
                    <span id="progress-indicator" class="text-xs text-dim font-mono">0%</span>
                </div>
                <div class="h-1 w-full bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-accent transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Verse Display -->
            <div id="verse-display" class="verse-font text-2xl md:text-4xl leading-relaxed md:leading-relaxed text-center no-select cursor-text transition-opacity duration-300 w-full break-words" onclick="focusInput()">
                <!-- Content injected via JS -->
            </div>

            <div id="mobile-hint" class="mt-8 text-sm text-dim opacity-50 md:hidden">
                Tap text to open keyboard
            </div>
        </div>

        <!-- Results Screen -->
        <div id="result-screen" class="hidden flex-1 flex flex-col items-center justify-center text-center space-y-6 fade-in pb-8">
            <div id="result-icon" class="w-16 h-16 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            
            <div class="space-y-1">
                <h2 class="text-3xl font-bold">Verse Completed!</h2>
                <!-- Result Streak -->
                <div id="result-streak-badge" class="hidden flex items-center justify-center pt-1 animate-pop-in select-none">
                    <span class="text-3xl leading-none">ðŸ”¥</span>
                    <span class="w-2"></span> 
                    <span id="result-streak-count" class="text-3xl font-bold text-accent leading-none">0</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 w-full max-w-xs mt-4">
                <div class="card p-4 rounded-lg text-center">
                    <div class="text-xs text-dim uppercase tracking-wider mb-1">Accuracy</div>
                    <div id="accuracy-score" class="text-2xl font-bold text-accent">100%</div>
                </div>
                <div class="card p-4 rounded-lg text-center">
                    <div class="text-xs text-dim uppercase tracking-wider mb-1">Errors</div>
                    <div id="error-count" class="text-2xl font-bold text-red-500">0</div>
                </div>
            </div>

            <!-- Buttons - Updated Layout with Hidden Desktop Hints on Mobile -->
            <div class="grid grid-cols-2 gap-4 w-full max-w-xs mt-6">
                <button onclick="restartVerse()" class="w-full py-2.5 rounded-lg border border-current opacity-60 hover:opacity-100 transition-all active:scale-95 transform duration-150">
                    Restart <span class="hidden md:inline">(R)</span>
                </button>
                <button onclick="showSetup()" class="w-full py-2.5 rounded-lg bg-accent text-white shadow hover:shadow-lg transition-all active:scale-95 transform duration-150">
                    New Verse <span class="hidden md:inline">(N)</span>
                </button>
            </div>
        </div>

    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
        <div class="card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold">History</h3>
                <button onclick="toggleHistory()" class="text-dim hover:text-accent transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div id="history-list" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- History Items Injected Here -->
            </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-700 shrink-0">
                <button onclick="showClearConfirmation()" class="w-full py-2 text-xs text-red-500 hover:text-red-600 font-medium">Clear History</button>
            </div>
        </div>
    </div>

    <!-- Clear History Confirmation Modal -->
    <div id="clear-history-modal" class="fixed inset-0 z-[60] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
        <div class="card w-full max-w-xs rounded-xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="p-6 text-center space-y-4">
                <h4 class="text-lg font-bold">Clear All History?</h4>
                <p class="text-dim text-sm">Are you sure you want to clear verse history? This cannot be undone.</p>
                <div class="flex space-x-3 pt-2">
                    <button onclick="closeClearConfirmation()" class="flex-1 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm font-medium">
                        Cancel
                    </button>
                    <button onclick="confirmClearHistory()" class="flex-1 py-2.5 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-bold shadow-sm">
                        Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Commands Modal -->
    <div id="commands-modal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
        <div class="card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100 flex flex-col">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold">Secrets</h3>
                <button onclick="toggleCommands()" class="text-dim hover:text-accent transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="p-6 space-y-4 text-sm">
                <!-- Copiable Commands with clipboard buttons -->
                <div class="flex justify-between items-center bg-black/10 dark:bg-white/5 p-3 rounded-lg">
                    <div>
                        <span class="font-bold text-accent block">Thedevilmademedoit</span>
                        <span class="text-dim text-xs">Lose control. Refresh to stop.</span>
                    </div>
                    <button onclick="copyCommand('Thedevilmademedoit', this)" class="p-2 text-dim hover:text-accent transition-colors" title="Copy to clipboard">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                </div>
                
                <div class="flex justify-between items-center bg-black/10 dark:bg-white/5 p-3 rounded-lg">
                    <div>
                        <span class="font-bold text-accent block">Chargehellwithasquirtgun</span>
                        <span class="text-dim text-xs">Minigame: Extinguish the fires.</span>
                    </div>
                    <button onclick="copyCommand('Chargehellwithasquirtgun', this)" class="p-2 text-dim hover:text-accent transition-colors" title="Copy to clipboard">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 fade-in">
        <div class="card w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-100">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-bold">Settings</h3>
                <button onclick="toggleSettings()" class="text-dim hover:text-accent transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="p-6 space-y-6 overflow-y-auto max-h-[80vh]">
                <!-- Theme Selector -->
                <div>
                    <label class="block text-sm font-medium text-dim mb-3">Theme</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setTheme('theme-light')" class="h-10 rounded-lg border-2 border-gray-200 bg-[#f3f4f6] hover:border-blue-500 focus:ring-2 ring-blue-500 ring-offset-2 ring-offset-white dark:ring-offset-gray-800 transition-transform active:scale-95"></button>
                        <button onclick="setTheme('theme-dark')" class="h-10 rounded-lg border-2 border-gray-600 bg-[#09090b] hover:border-blue-500 focus:ring-2 ring-blue-500 ring-offset-2 ring-offset-white dark:ring-offset-gray-800 transition-transform active:scale-95"></button>
                        <button onclick="setTheme('theme-midnight')" class="h-10 rounded-lg border-2 border-slate-600 bg-[#0f172a] hover:border-blue-500 focus:ring-2 ring-blue-500 ring-offset-2 ring-offset-white dark:ring-offset-gray-800 transition-transform active:scale-95"></button>
                        <button onclick="setTheme('theme-crimson')" class="h-10 rounded-lg border-2 border-red-900 bg-[#450a0a] hover:border-red-500 focus:ring-2 ring-red-500 ring-offset-2 ring-offset-white dark:ring-offset-gray-800 transition-transform active:scale-95"></button>
                    </div>
                    <div class="flex justify-between text-xs text-dim mt-1 px-1">
                        <span>Light</span><span>Dark</span><span>Midnight</span><span>Crimson</span>
                    </div>
                </div>

                <!-- Toggles Container -->
                <div class="space-y-4">
                    <!-- Strict Accuracy Slider -->
                    <div id="accuracy-setting-container" class="opacity-100 transition-opacity duration-300">
                        <div class="flex items-center justify-between mb-2">
                            <label for="strict-mode" class="flex flex-col">
                                <span class="text-sm font-medium">Strict Accuracy</span>
                                <span class="text-xs text-dim mt-0.5">Autocorrect adjacent keys (Mobile)</span>
                            </label>
                            
                            <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="strict-mode" id="strict-mode" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked onclick="toggleStrict()">
                                <label for="strict-mode" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <p id="desktop-warning" class="text-xs text-orange-500 hidden mt-1">
                            * Disabled on desktop
                        </p>
                    </div>

                    <!-- Auto Preview Slider -->
                    <div class="flex items-center justify-between mb-2">
                        <label for="auto-preview" class="flex flex-col">
                            <span class="text-sm font-medium">Auto Preview</span>
                            <span class="text-xs text-dim mt-0.5">Show verse preview automatically</span>
                        </label>
                        
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="auto-preview" id="auto-preview" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" onclick="toggleAutoPreview()">
                            <label for="auto-preview" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>

                    <!-- Auto Skip Visible Words Slider -->
                    <div class="flex items-center justify-between mb-2">
                        <label for="auto-skip" class="flex flex-col">
                            <span class="text-sm font-medium">Skip Revealed Words</span>
                            <span class="text-xs text-dim mt-0.5">Only type the hidden blanks in Quiz Mode</span>
                        </label>
                        
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="auto-skip" id="auto-skip" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" onclick="toggleAutoSkip()">
                            <label for="auto-skip" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
                
                <!-- In-Game Mode Switcher (Only visible when game active) -->
                <div id="ingame-switch-container" class="hidden pt-4 border-t border-gray-200 dark:border-gray-700">
                     <button onclick="toggleGameModeIngame(); toggleSettings()" id="switch-mode-btn" class="w-full py-2.5 rounded-lg bg-accent text-white hover:opacity-90 transition-all active:scale-95 transform duration-150 text-sm font-bold shadow-sm">
                        Switch to Quiz Mode
                    </button>
                </div>

                <!-- Main Menu Button in Settings -->
                <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                    <button onclick="showSetup(); toggleSettings()" class="w-full py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all active:scale-95 transform duration-150 text-sm font-medium">
                        Return to Main Menu (M)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fire Game Overlay -->
    <div id="fire-game-layer" class="fixed inset-0 z-[100] hidden flex items-center justify-center text-white cursor-none">
        <div id="water-gun">ðŸ”«</div>
        <div id="bible-cursor">ðŸ“–</div>
        <div id="fire-timer" class="absolute top-4 right-4 text-3xl font-bold font-mono">15</div>
        <div id="fire-msg" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold hidden text-center w-full px-4"></div>
    </div>

    <!-- Hidden Input - Moved inside #app for structural consistency -->
    <textarea id="hidden-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>

    <script>
        // --- Declarations (moved to top-level, initialized in init) ---
        let app, setupScreen, gameScreen, resultScreen, settingsModal, historyModal, commandsModal, clearHistoryModal;
        let historyList, verseDisplay, hiddenInput, progressBar, progressIndicator;
        let settingsBtn, strictToggle, autoPreviewToggle, autoSkipToggle, desktopWarning;
        let accuracyContainer, ingameSwitchContainer, switchModeBtn, resultIcon, audioBtn;
        let headerStreakCount, headerStreak, resultStreakCount, resultStreakBadge, audioToggleBtns;
        let maskSlider, maskPercentDisplay, maskControls, fireGameLayer, fireTimerDisplay, fireMsg;
        let inputRef, fetchBtn, previewContainer, previewText, startBtn, errorMsg, btnMemorize, btnQuiz;
        let waterGun, bibleCursor, gameRestartBtn;

        // --- State ---
        let currentVerseRef = "";
        let currentText = "";
        let lastFetchedInput = "";
        let currentIndex = 0;
        let errors = 0;
        let totalKeystrokes = 0;
        let isGameActive = false;
        let strictMode = true; 
        let autoPreview = false; 
        let autoSkip = true; 
        let gameMode = 'memorize'; 
        let isMobile = false;
        let previewTimeout = null;
        let verseHistory = [];
        let streak = 0;
        let lastStreakDate = null;
        let isSpeaking = false;
        let availableVoices = [];
        let originalWords = []; 
        let indicesToMask = new Set(); 
        let stableShuffledIndices = [];
        
        // Easter Egg State
        let fireGameInterval = null;
        let fireGameTimer = 15;
        let firesLeft = 0;

        // --- Adjacency Map ---
        const adjacencyMap = {
            'q': 'wa', 'w': 'qase', 'e': 'wsdr', 'r': 'edft', 't': 'rfgy', 'y': 'tghu', 'u': 'yhji', 'i': 'ujko', 'o': 'iklp', 'p': 'ol',
            'a': 'qwsz', 's': 'qweadzx', 'd': 'ersfcx', 'f': 'rtdgcv', 'g': 'tyfhvb', 'h': 'ybgjnm', 'j': 'uikhnm', 'k': 'iojlm', 'l': 'opk',
            'z': 'asx', 'x': 'zsdc', 'c': 'xdfv', 'v': 'cfgb', 'b': 'vghn', 'n': 'bhjm', 'm': 'njk'
        };

        // --- Bible Abbreviations Map ---
        const bibleAbbreviations = {
            "gn": "Genesis", "gen": "Genesis", "ex": "Exodus", "exo": "Exodus", "lv": "Leviticus", "lev": "Leviticus",
            "nm": "Numbers", "num": "Numbers", "dt": "Deuteronomy", "deu": "Deuteronomy", "deut": "Deuteronomy",
            "js": "Joshua", "jos": "Joshua", "josh": "Joshua", "jg": "Judges", "jdg": "Judges", "judg": "Judges",
            "rt": "Ruth", "rut": "Ruth", "1sm": "1 Samuel", "1sa": "1 Samuel", "1sam": "1 Samuel", "2sm": "2 Samuel", "2sa": "2 Samuel", "2sam": "2 Samuel",
            "1kg": "1 Kings", "1ki": "1 Kings", "1kgs": "1 Kings", "2kg": "2 Kings", "2ki": "2 Kings", "2kgs": "2 Kings",
            "1ch": "1 Chronicles", "1chr": "1 Chronicles", "2ch": "2 Chronicles", "2chr": "2 Chronicles", "ez": "Ezra", "ezr": "Ezra",
            "ne": "Nehemiah", "neh": "Nehemiah", "es": "Esther", "est": "Esther", "jb": "Job", "job": "Job",
            "ps": "Psalms", "psa": "Psalms", "psalm": "Psalms", "pr": "Proverbs", "pro": "Proverbs", "prov": "Proverbs",
            "ec": "Ecclesiastes", "ecc": "Ecclesiastes", "so": "Song of Solomon", "sos": "Song of Solomon", "song": "Song of Solomon",
            "is": "Isaiah", "isa": "Isaiah", "je": "Jeremiah", "jer": "Jeremiah", "lm": "Lamentations", "lam": "Lamentations",
            "ek": "Ezekiel", "ezk": "Ezekiel", "eze": "Ezekiel", "da": "Daniel", "dan": "Daniel", "ho": "Hosea", "hos": "Hosea",
            "jl": "Joel", "joe": "Joel", "am": "Amos", "amo": "Amos", "ob": "Obadiah", "oba": "Obadiah",
            "jn": "John", "jhn": "John", "jon": "John", "joh": "John", "mi": "Micah", "mic": "Micah",
            "na": "Nahum", "nah": "Nahum", "hb": "Habakkuk", "hab": "Habakkuk", "zp": "Zephaniah", "zep": "Zephaniah",
            "hg": "Haggai", "hag": "Haggai", "zc": "Zechariah", "zec": "Zechariah", "ml": "Malachi", "mal": "Malachi",
            "mt": "Matthew", "mat": "Matthew", "matt": "Matthew", "mk": "Mark", "mar": "Mark", "lk": "Luke", "luk": "Luke",
            "ac": "Acts", "act": "Acts", "rm": "Romans", "rom": "Romans", "1co": "1 Corinthians", "1cor": "1 Corinthians",
            "2co": "2 Corinthians", "2cor": "2 Corinthians", "ga": "Galatians", "gal": "Galatians", "ep": "Ephesians", "eph": "Ephesians",
            "ph": "Philippians", "phi": "Philippians", "phil": "Philippians", "cl": "Colossians", "col": "Colossians",
            "1th": "1 Thessalonians", "1thess": "1 Thessalonians",
            "2th": "2 Thessalonians", "2thess": "2 Thessalonians",
            "1ti": "1 Timothy", "1tim": "1 Timothy",
            "2ti": "2 Timothy", "2tim": "2 Timothy",
            "tt": "Titus", "tit": "Titus",
            "pm": "Philemon", "phm": "Philemon",
            "he": "Hebrews", "heb": "Hebrews",
            "jm": "James", "jas": "James", "jam": "James",
            "1pe": "1 Peter", "1pet": "1 Peter",
            "2pe": "2 Peter", "2pet": "2 Peter",
            "1jn": "1 John", "1jhn": "1 John", "1joh": "1 John",
            "2jn": "2 John", "2jhn": "2 John", "2joh": "2 John",
            "3jn": "3 John", "3jhn": "3 John", "3joh": "3 John",
            "jd": "Jude", "jud": "Jude",
            "re": "Revelation", "rev": "Revelation"
        };

        // --- Initialization ---
        function init() {
            // Assign elements
            app = document.getElementById('app');
            setupScreen = document.getElementById('setup-screen');
            gameScreen = document.getElementById('game-screen');
            resultScreen = document.getElementById('result-screen');
            settingsModal = document.getElementById('settings-modal');
            historyModal = document.getElementById('history-modal');
            commandsModal = document.getElementById('commands-modal');
            clearHistoryModal = document.getElementById('clear-history-modal');
            historyList = document.getElementById('history-list');
            verseDisplay = document.getElementById('verse-display');
            hiddenInput = document.getElementById('hidden-input');
            progressBar = document.getElementById('progress-bar');
            progressIndicator = document.getElementById('progress-indicator');
            settingsBtn = document.getElementById('settings-btn');
            strictToggle = document.getElementById('strict-mode');
            autoPreviewToggle = document.getElementById('auto-preview');
            autoSkipToggle = document.getElementById('auto-skip');
            desktopWarning = document.getElementById('desktop-warning');
            accuracyContainer = document.getElementById('accuracy-setting-container');
            ingameSwitchContainer = document.getElementById('ingame-switch-container');
            switchModeBtn = document.getElementById('switch-mode-btn');
            resultIcon = document.getElementById('result-icon');
            audioBtn = document.getElementById('audio-btn');
            headerStreakCount = document.getElementById('header-streak-count');
            headerStreak = document.getElementById('header-streak');
            resultStreakCount = document.getElementById('result-streak-count');
            resultStreakBadge = document.getElementById('result-streak-badge');
            audioToggleBtns = document.querySelectorAll('.audio-toggle-btn');
            maskSlider = document.getElementById('mask-slider');
            maskPercentDisplay = document.getElementById('mask-percent-display');
            maskControls = document.getElementById('mask-controls');
            gameRestartBtn = document.getElementById('game-restart-btn');
            
            fireGameLayer = document.getElementById('fire-game-layer');
            fireTimerDisplay = document.getElementById('fire-timer');
            fireMsg = document.getElementById('fire-msg');
            waterGun = document.getElementById('water-gun');
            bibleCursor = document.getElementById('bible-cursor');
            
            inputRef = document.getElementById('input-ref');
            fetchBtn = document.getElementById('fetch-btn');
            previewContainer = document.getElementById('preview-container');
            previewText = document.getElementById('preview-text');
            startBtn = document.getElementById('start-btn');
            errorMsg = document.getElementById('error-msg');
            
            btnMemorize = document.getElementById('btn-memorize');
            btnQuiz = document.getElementById('btn-quiz');

            // Fallback for hidden input if missing (fixes copy/paste issues)
            if (!hiddenInput) {
                hiddenInput = document.createElement('textarea');
                hiddenInput.id = 'hidden-input';
                document.body.appendChild(hiddenInput);
            }

            const missing = [];
            if (!inputRef) missing.push("inputRef");
            if (!settingsBtn) missing.push("settingsBtn");
            
            if (missing.length > 0) {
                console.error("Critical elements missing:", missing.join(", "));
                return;
            }

            detectDevice();
            loadSettings();
            
            setTimeout(() => inputRef.focus(), 100);
            
            document.addEventListener('keydown', handleDesktopInput);
            hiddenInput.addEventListener('input', handleMobileInput);
            settingsBtn.addEventListener('click', toggleSettings);
            
            inputRef.addEventListener('input', () => {
                if (!autoPreview) return;
                clearTimeout(previewTimeout);
                previewTimeout = setTimeout(() => fetchVerse(false), 800); 
            });
            
            if ('speechSynthesis' in window) {
                audioToggleBtns.forEach(btn => btn.classList.remove('hidden'));
                window.speechSynthesis.onvoiceschanged = () => {
                    availableVoices = window.speechSynthesis.getVoices();
                };
            }
            
            updateSettingsUI();
        }

        // --- Helper Functions ---
        function getBestVoice() {
            if (availableVoices.length === 0) availableVoices = window.speechSynthesis.getVoices();
            const preferredVoices = ['Google UK English Male', 'Daniel', 'Google US English', 'Samantha', 'Microsoft Zira'];
            for (const name of preferredVoices) {
                const voice = availableVoices.find(v => v.name.includes(name));
                if (voice) return voice;
            }
            return availableVoices.find(v => v.lang === 'en-GB') || availableVoices.find(v => v.lang.startsWith('en')) || null;
        }

        function detectDevice() {
            isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent) || (navigator.maxTouchPoints > 0 && window.matchMedia("(pointer: coarse)").matches);
            if (!isMobile) {
                accuracyContainer.classList.add('opacity-50', 'pointer-events-none');
                desktopWarning.classList.remove('hidden');
            } else {
                accuracyContainer.classList.remove('opacity-50', 'pointer-events-none');
                desktopWarning.classList.add('hidden');
            }
        }

        function loadSettings() {
            setTheme(localStorage.getItem('verseMasterTheme') || 'theme-dark');
            const savedHistory = localStorage.getItem('verseMasterHistory');
            if (savedHistory) { try { verseHistory = JSON.parse(savedHistory); } catch(e) { verseHistory = []; } }
            
            streak = parseInt(localStorage.getItem('verseMasterStreak') || '0', 10);
            lastStreakDate = localStorage.getItem('verseMasterStreakDate');
            updateStreakDisplay();
            
            const savedStrict = localStorage.getItem('verseMasterStrict');
            if (savedStrict !== null) { strictMode = savedStrict === 'true'; strictToggle.checked = strictMode; }
            
            const savedAutoPreview = localStorage.getItem('verseMasterAutoPreview');
            if (savedAutoPreview !== null) { autoPreview = savedAutoPreview === 'true'; autoPreviewToggle.checked = autoPreview; }
            
            const savedAutoSkip = localStorage.getItem('verseMasterAutoSkip');
            if (savedAutoSkip !== null) { autoSkip = savedAutoSkip === 'true'; autoSkipToggle.checked = autoSkip; } else { autoSkipToggle.checked = true; }
            
            const savedMode = localStorage.getItem('verseMasterMode');
            if (savedMode) { setGameMode(savedMode); } else { setGameMode('memorize'); }
        }

        function saveSettings() {
            localStorage.setItem('verseMasterStrict', strictMode);
            localStorage.setItem('verseMasterAutoPreview', autoPreview);
            localStorage.setItem('verseMasterAutoSkip', autoSkip);
            localStorage.setItem('verseMasterMode', gameMode);
        }

        function setTheme(themeName) {
            document.body.className = `${themeName} h-screen w-screen flex flex-col items-center justify-center relative`;
            localStorage.setItem('verseMasterTheme', themeName);
        }

        function toggleStrict() { strictMode = strictToggle.checked; saveSettings(); }
        function toggleAutoPreview() { autoPreview = autoPreviewToggle.checked; saveSettings(); }
        function toggleAutoSkip() { autoSkip = autoSkipToggle.checked; saveSettings(); }
        
        function toggleCommands() {
            const isHidden = commandsModal.classList.contains('hidden');
            if (isHidden) { commandsModal.classList.remove('hidden'); } else { commandsModal.classList.add('hidden'); }
        }

        function setGameMode(mode) {
            gameMode = mode;
            if (mode === 'memorize') {
                btnMemorize.classList.add('active'); btnMemorize.classList.remove('inactive');
                btnQuiz.classList.add('inactive'); btnQuiz.classList.remove('active');
                maskControls.classList.add('hidden');
            } else {
                btnQuiz.classList.add('active'); btnQuiz.classList.remove('inactive');
                btnMemorize.classList.add('inactive'); btnMemorize.classList.remove('active');
                maskControls.classList.remove('hidden');
            }
            saveSettings();
        }

        function toggleGameModeIngame() {
            const newMode = gameMode === 'memorize' ? 'quiz' : 'memorize';
            setGameMode(newMode);
            applyModeClasses();
            
            // CRITICAL: Advance cursor if switching to Quiz
            if (newMode === 'quiz' && autoSkip) {
               advanceCursor();
            }
            
            updateDisplay();
            
            // Update Audio Button Visibility based on mode
            // If quiz mode, ensure audio is hidden in game
            if (newMode === 'quiz') {
                 document.getElementById('game-audio-btn').classList.add('hidden');
                 // Also stop any playing audio
                 window.speechSynthesis.cancel();
                 isSpeaking = false;
                 updateAudioIcons(false);
            } else {
                 if ('speechSynthesis' in window) {
                     document.getElementById('game-audio-btn').classList.remove('hidden');
                 }
            }

            switchModeBtn.innerText = newMode === 'memorize' ? 'Switch to Quiz Mode' : 'Switch to Memorize Mode';
        }

        function applyModeClasses() {
            verseDisplay.classList.remove('mode-memorize', 'mode-quiz');
            verseDisplay.classList.add(`mode-${gameMode}`);
        }

        function addToHistory(ref, text) {
            if (verseHistory.length > 0 && verseHistory[0].ref === ref) return;
            verseHistory = verseHistory.filter(v => v.ref !== ref);
            verseHistory.unshift({ ref, text, date: new Date().toISOString() });
            if (verseHistory.length > 50) verseHistory.pop();
            localStorage.setItem('verseMasterHistory', JSON.stringify(verseHistory));
        }

        function toggleHistory() {
            const isHidden = historyModal.classList.contains('hidden');
            if (isHidden) { renderHistory(); historyModal.classList.remove('hidden'); } else { historyModal.classList.add('hidden'); inputRef.focus(); }
        }

        function renderHistory() {
            historyList.innerHTML = '';
            if (verseHistory.length === 0) { historyList.innerHTML = '<div class="text-center text-dim text-sm py-4">No history yet</div>'; return; }
            verseHistory.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'history-item p-3 rounded-lg cursor-pointer flex flex-col';
                div.innerHTML = `<span class="font-bold text-accent">${item.ref}</span><span class="text-xs text-dim truncate">${item.text}</span>`;
                div.onclick = () => loadHistoryItem(item);
                historyList.appendChild(div);
            });
        }

        function loadHistoryItem(item) {
            currentVerseRef = item.ref; currentText = item.text; lastFetchedInput = item.ref; inputRef.value = item.ref;
            originalWords = tokenizeText(currentText);
            updateMasking(maskSlider.value);
            previewContainer.classList.remove('hidden');
            historyModal.classList.add('hidden');
            setTimeout(() => { inputRef.focus(); }, 100);
        }

        function showClearConfirmation() { clearHistoryModal.classList.remove('hidden'); }
        function closeClearConfirmation() { clearHistoryModal.classList.add('hidden'); }
        function confirmClearHistory() { verseHistory = []; localStorage.removeItem('verseMasterHistory'); renderHistory(); closeClearConfirmation(); }
        
        function copyCommand(command, btnElement) {
            const textArea = document.createElement("textarea");
            textArea.value = command;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    if (btnElement) {
                         const originalHTML = btnElement.innerHTML;
                         btnElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                         setTimeout(() => {
                             btnElement.innerHTML = originalHTML;
                         }, 1000);
                    }
                }
            } catch (err) { console.error('Fallback: Oops, unable to copy', err); }
            document.body.removeChild(textArea);
        }

        function updateAudioIcons(playing) {
            audioToggleBtns.forEach(btn => {
                const playIcon = btn.querySelector('.icon-play');
                const stopIcon = btn.querySelector('.icon-stop');
                if (playing) {
                    playIcon.classList.add('hidden'); stopIcon.classList.remove('hidden');
                    btn.classList.remove('text-dim'); btn.classList.add('text-accent', 'playing-audio');
                } else {
                    playIcon.classList.remove('hidden'); stopIcon.classList.add('hidden');
                    btn.classList.remove('text-accent', 'playing-audio'); btn.classList.add('text-dim');
                }
            });
        }

        function toggleAudio() {
            // Security check: Disable audio in Quiz Mode
            if (gameMode === 'quiz' && isGameActive) return;

            if (!currentText) return;
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                updateAudioIcons(false);
            } else {
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(currentText);
                const bestVoice = getBestVoice();
                if (bestVoice) utterance.voice = bestVoice;
                utterance.rate = 0.9; utterance.pitch = 1.0; 
                utterance.onend = () => { isSpeaking = false; updateAudioIcons(false); };
                window.speechSynthesis.speak(utterance);
                isSpeaking = true;
                updateAudioIcons(true);
            }
        }

        function tokenizeText(text) { return text.match(/(\w+|[^\w]+)/g) || []; }

        function resetMasking() { 
            originalWords = tokenizeText(currentText);
            
            // Generate STABLE shuffle indices
            const wordIndices = originalWords.map((t, i) => /\w/.test(t) ? i : -1).filter(i => i !== -1);
            stableShuffledIndices = [...wordIndices];
            
            // Fisher-Yates Shuffle
            for (let i = stableShuffledIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [stableShuffledIndices[i], stableShuffledIndices[j]] = [stableShuffledIndices[j], stableShuffledIndices[i]];
            }
        }

        function updateMasking(percentage) {
            maskPercentDisplay.textContent = `${percentage}%`;
            
            if (!originalWords.length || !stableShuffledIndices.length) {
                // If data missing, try re-init
                if (currentText) resetMasking();
                else return; // Nothing to do
            }

            const totalWords = stableShuffledIndices.length;
            const countToMask = Math.floor((percentage / 100) * totalWords);
            
            // Use slicing of STABLE shuffled array
            indicesToMask = new Set(stableShuffledIndices.slice(0, countToMask));
            
            // Preview always shows full text per request
            previewText.innerHTML = escapeHtml(currentText);
        }

        function updateStreak() {
            const today = new Date().toDateString();
            if (lastStreakDate !== today) {
                if (lastStreakDate) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    if (yesterday.toDateString() === lastStreakDate) { streak++; } else { streak = 1; }
                } else { streak = 1; }
                lastStreakDate = today;
                localStorage.setItem('verseMasterStreak', streak);
                localStorage.setItem('verseMasterStreakDate', lastStreakDate);
                updateStreakDisplay();
            }
        }

        function updateStreakDisplay() {
            if (streak > 0) {
                headerStreakCount.textContent = streak;
                resultStreakCount.textContent = streak;
                headerStreak.classList.remove('hidden');
                resultStreakBadge.classList.remove('hidden');
            }
        }

        function showSetup() {
            isGameActive = false;
            window.speechSynthesis.cancel(); 
            isSpeaking = false;
            updateAudioIcons(false);
            setupScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            hiddenInput.blur();
            ingameSwitchContainer.classList.add('hidden');
            inputRef.value = "";
            previewContainer.classList.add('hidden');
            errorMsg.classList.add('hidden');
            resultIcon.classList.remove('pop-in');
            setTimeout(() => inputRef.focus(), 50);
        }

        function normalizeReference(rawRef) {
            const match = rawRef.match(/^(\d?\s*[a-zA-Z]+)(.*)$/);
            if (!match) return rawRef;
            const bookPart = match[1].trim().toLowerCase().replace(/\s+/g, '');
            const rest = match[2];
            if (bibleAbbreviations[bookPart]) return bibleAbbreviations[bookPart] + rest;
            return rawRef;
        }

        async function fetchVerse(isSilent = false) {
            const rawRef = inputRef.value.trim();
            if (!rawRef) return false;
            const ref = normalizeReference(rawRef);
            
            // Update input to look pretty if fixed
            if (ref !== rawRef && !isSilent) {
                // optional: inputRef.value = ref; 
            }

            if (!isSilent && !previewContainer.classList.contains('hidden') && event?.target?.id === 'fetch-btn') {
                // Button Toggle State Logic
                // If it was text, it stays text. If icon, stays icon.
                // We don't change innerHTML here anymore to preserve responsive icon state
                previewContainer.classList.add('hidden'); 
                return true; 
            }

            if (!isSilent) {
                // Loading State logic if desired, but we want to keep icon stable
                // fetchBtn.classList.add('opacity-50'); 
            }
            
            errorMsg.classList.add('hidden');
            try {
                const response = await fetch(`https://bible-api.com/${encodeURIComponent(ref)}?translation=kjv`);
                const data = await response.json();
                if (response.ok && data.text) {
                    currentVerseRef = data.reference;
                    currentText = data.text.replace(/\s+/g, ' ').trim();
                    lastFetchedInput = rawRef; 
                    resetMasking();
                    updateMasking(maskSlider.value);
                    if (!isSilent) previewContainer.classList.remove('hidden');
                    return true;
                } else { throw new Error('Verse not found'); }
            } catch (err) {
                errorMsg.textContent = "Could not find verse (KJV). Check reference.";
                errorMsg.classList.remove('hidden');
                if (!isSilent) previewContainer.classList.add('hidden');
                return false;
            } finally { 
                // Restore button state if we messed with it
                // fetchBtn.classList.remove('opacity-50'); 
            }
        }

        // --- Cheat Codes & Easter Eggs ---
        function checkCheatCodes(input) {
            const code = input.toLowerCase().replace(/\s+/g, '');
            if (code === '/commands') {
                toggleCommands();
                return true;
            }
            if (code === 'thedevilmademedoit') {
                startPossessedMode();
                return true;
            }
            if (code === 'chargehellwithasquirtgun') {
                startFireGame();
                return true;
            }
            return false;
        }

        function startPossessedMode() {
            document.body.classList.add('possessed');
            // Create Fake Cursor
            const fakeCursor = document.createElement('div');
            fakeCursor.className = 'fake-cursor';
            document.body.appendChild(fakeCursor);

            // Chaotic Interval
            setInterval(() => {
                // Randomly move fake cursor
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                fakeCursor.style.left = x + 'px';
                fakeCursor.style.top = y + 'px';

                // Randomly focus/blur inputs
                if(Math.random() > 0.7) inputRef.focus();
                if(Math.random() > 0.7) hiddenInput.focus();
                
                // Randomly click buttons
                const buttons = document.querySelectorAll('button');
                const randomBtn = buttons[Math.floor(Math.random() * buttons.length)];
                if(randomBtn && Math.random() > 0.8) {
                    // Visually simulate click active state
                    randomBtn.classList.add('active');
                    setTimeout(() => randomBtn.classList.remove('active'), 100);
                }

                // Random scroll
                if(Math.random() > 0.9) window.scrollTo(0, Math.random() * 100);

            }, 200);
        }

        function startFireGame() {
            fireGameLayer.classList.remove('hidden');
            fireGameTimer = 15;
            firesLeft = 30;
            fireTimerDisplay.innerText = fireGameTimer;
            fireMsg.classList.add('hidden');
            fireMsg.innerText = '';
            
            const existingFires = document.querySelectorAll('.fire-emoji');
            existingFires.forEach(f => f.remove());

            function trackMouse(e) {
                bibleCursor.style.left = e.clientX + 'px';
                bibleCursor.style.top = e.clientY + 'px';
                
                const gunX = window.innerWidth / 2;
                const gunY = window.innerHeight * 0.9; // Adjusted for gun position
                const deltaX = e.clientX - gunX;
                const deltaY = e.clientY - gunY;
                const rad = Math.atan2(deltaY, deltaX); 
                let deg = rad * (180 / Math.PI);
                waterGun.style.transform = `translateX(-50%) rotate(${deg + 90}deg)`; // +90 because emoji points UP
            }
            
            window.addEventListener('mousemove', trackMouse);
            // Hide default cursor on game layer
            
            for(let i=0; i<30; i++) {
                const fire = document.createElement('div');
                fire.className = 'fire-emoji';
                fire.innerText = 'ðŸ”¥';
                fire.style.fontSize = (Math.random() * 2 + 1) + 'rem';
                fire.style.left = (Math.random() * 90 + 5) + '%'; // Keep away from edges slightly
                fire.style.top = (Math.random() * 70 + 5) + '%';
                
                fire.onclick = function(e) {
                    e.stopPropagation(); // Prevent double triggering
                    
                    // Visual Effect: Water Projectile
                    const rect = fire.getBoundingClientRect();
                    const fireX = rect.left + rect.width / 2;
                    const fireY = rect.top + rect.height / 2;
                    
                    const drop = document.createElement('div');
                    drop.className = 'water-projectile';
                    drop.innerText = 'ðŸ’§';
                    
                    // Start from gun nozzle location approx
                    drop.style.left = '50%'; 
                    drop.style.bottom = '10%'; 
                    
                    fireGameLayer.appendChild(drop);
                    
                    // Force reflow
                    void drop.offsetWidth;
                    
                    // Calc vector
                    const startX = window.innerWidth / 2;
                    const startY = window.innerHeight * 0.9;
                    const travelX = fireX - startX;
                    const travelY = fireY - startY;

                    drop.style.transform = `translate(${travelX}px, ${travelY}px)`;
                    
                    setTimeout(() => {
                         drop.remove();
                         this.remove();
                         firesLeft--;
                         if(firesLeft <= 0) endGame(true);
                    }, 200); 
                };
                
                fireGameLayer.appendChild(fire);
            }

            // Timer Loop
            fireGameInterval = setInterval(() => {
                fireGameTimer--;
                fireTimerDisplay.innerText = fireGameTimer;
                if (fireGameTimer <= 0) {
                    endGame(false);
                }
            }, 1000);

            function endGame(win) {
                clearInterval(fireGameInterval);
                window.removeEventListener('mousemove', trackMouse);
                fireMsg.classList.remove('hidden');
                if(win) {
                    fireMsg.innerText = "VICTORY! HELL IS QUENCHED!";
                    fireMsg.style.color = "#4ade80"; // Green
                } else {
                    fireMsg.innerText = "GAME OVER. YOU BURNED.";
                    fireMsg.style.color = "#f87171"; // Red
                }
                setTimeout(() => {
                    fireGameLayer.classList.add('hidden');
                    // Reset View
                }, 3000);
            }
        }

        async function startCustomGame() {
            const inputValue = inputRef.value.trim();
            if (!inputValue) { inputRef.focus(); return; }

            // Check Cheat Codes first
            if (checkCheatCodes(inputValue)) return;

            const expandedInput = normalizeReference(inputValue);

            if (!currentText || inputValue.toLowerCase() !== lastFetchedInput.toLowerCase()) {
                const originalText = startBtn.innerText;
                startBtn.innerText = "Loading...";
                startBtn.disabled = true; 
                const success = await fetchVerse(true); 
                startBtn.innerText = originalText;
                startBtn.disabled = false;
                if (!success) return; 
            }
            
            addToHistory(currentVerseRef, currentText);
            restartVerse();
        }

        function restartVerse() {
            currentIndex = 0;
            errors = 0;
            totalKeystrokes = 0;
            isGameActive = true;
            window.speechSynthesis.cancel();
            isSpeaking = false;
            updateAudioIcons(false);
            setupScreen.classList.add('hidden');
            resultScreen.classList.add('hidden');
            resultIcon.classList.remove('pop-in'); 
            gameScreen.classList.remove('hidden');
            ingameSwitchContainer.classList.remove('hidden');
            switchModeBtn.innerText = gameMode === 'memorize' ? 'Switch to Quiz Mode' : 'Switch to Memorize Mode';
            document.getElementById('verse-reference').textContent = currentVerseRef;
            applyModeClasses();
            
            // Advance cursor logic for start
            if (!originalWords.length) originalWords = tokenizeText(currentText);
            advanceCursor();
            
            // Show/Hide Game Audio Button based on mode
            if (gameMode === 'quiz') {
                gameRestartBtn.classList.remove('hidden'); // Ensure reset btn is visible
                document.getElementById('game-audio-btn').classList.add('hidden');
            } else {
                if ('speechSynthesis' in window) {
                    document.getElementById('game-audio-btn').classList.remove('hidden');
                }
                gameRestartBtn.classList.remove('hidden');
            }

            updateDisplay();
            setTimeout(focusInput, 100);
        }

        function toggleSettings() {
            const isHidden = settingsModal.classList.contains('hidden');
            if (isHidden) { settingsModal.classList.remove('hidden'); } else {
                settingsModal.classList.add('hidden');
                if (isGameActive) focusInput();
                else if (!setupScreen.classList.contains('hidden')) inputRef.focus();
            }
        }

        function focusInput() { if (!isMobile) return; hiddenInput.value = ''; hiddenInput.focus(); }

        function handleDesktopInput(e) {
            if (e.key === 'Escape') {
                if (!commandsModal.classList.contains('hidden')) { toggleCommands(); return; }
                if (!clearHistoryModal.classList.contains('hidden')) { closeClearConfirmation(); return; }
                if (!historyModal.classList.contains('hidden')) { toggleHistory(); return; }
                toggleSettings(); return;
            }
            if (!settingsModal.classList.contains('hidden')) { 
                if (e.key.toLowerCase() === 'm') { 
                    e.preventDefault(); // Prevent M form typing
                    showSetup(); 
                    toggleSettings(); 
                } 
                return; 
            }
            if (!historyModal.classList.contains('hidden')) return;
            if (!clearHistoryModal.classList.contains('hidden')) return;
            if (!commandsModal.classList.contains('hidden')) return;
            if (!setupScreen.classList.contains('hidden')) return;
            if (!resultScreen.classList.contains('hidden')) {
                 if (e.key.toLowerCase() === 'n') { e.preventDefault(); showSetup(); return; }
                 if (e.key.toLowerCase() === 'r') { e.preventDefault(); restartVerse(); return; }
                 return;
            }
            if (!isGameActive) return;
            if (e.key.toLowerCase() === 'r' && !e.ctrlKey && !e.metaKey) { restartVerse(); return; }
            if (e.key.length > 1) return; 
            processInput(e.key);
        }

        function handleMobileInput(e) {
            if (!isGameActive) return;
            const val = e.target.value;
            if (val.length > 0) { const char = val.slice(-1); processInput(char); e.target.value = ''; }
        }

        // UPDATED: Logic to auto-skip spaces & punctuation
        function advanceCursor() {
             if (!originalWords.length) originalWords = tokenizeText(currentText);
             
             let charCount = 0;
             let tokenIndex = 0;
             
             // Fast-forward local counters to sync with global currentIndex
             while(tokenIndex < originalWords.length) {
                 if (charCount === currentIndex) break;
                 charCount += originalWords[tokenIndex].length;
                 tokenIndex++;
             }
             
             // Now check from current position forward
             while(tokenIndex < originalWords.length) {
                 const token = originalWords[tokenIndex];
                 
                 // Condition 1: Is it a word? If NOT a word (punctuation/space), we MUST skip it in BOTH modes
                 // Condition 2: If it IS a word, should we skip it because of Quiz Mode settings?
                 
                 const isWord = /\w/.test(token);
                 let shouldSkip = false;
                 
                 if (!isWord) {
                     // Always skip non-words
                     shouldSkip = true;
                 } else if (gameMode === 'quiz' && autoSkip) {
                     // In Quiz + AutoSkip: Skip if visible (NOT in mask set)
                     if (!indicesToMask.has(tokenIndex)) {
                         shouldSkip = true;
                     }
                 }
                 
                 if (shouldSkip) {
                     currentIndex += token.length;
                     charCount += token.length;
                     tokenIndex++;
                 } else {
                     break; // We found something we need to type (a word in Memorize, or a hidden word in Quiz)
                 }
             }
             
             if (currentIndex >= currentText.length && currentText.length > 0) {
                 finishGame();
             }
        }

        function processInput(char) {
            if (currentIndex >= currentText.length) return;

            // Identify current token based on originalWords
            if (!originalWords.length) originalWords = tokenizeText(currentText);
            
            let charCount = 0;
            let currentToken = null;
            
            for (const token of originalWords) {
                if (charCount === currentIndex) {
                    currentToken = token;
                    break;
                }
                charCount += token.length;
            }
            
            if (!currentToken) return; 

            const targetChar = currentToken[0]; 
            
            let isCorrect = false;
            const lowerInput = char.toLowerCase();
            const lowerTarget = targetChar.toLowerCase();
            if (lowerInput === lowerTarget) { isCorrect = true; }
            else if (isMobile && !strictMode) { if (adjacencyMap[lowerTarget] && adjacencyMap[lowerTarget].includes(lowerInput)) { isCorrect = true; } }
            
            totalKeystrokes++; 
            
            if (isCorrect) { 
                currentIndex += currentToken.length; 
                advanceCursor(); // Calls the unified skip logic
                updateDisplay(); 
                if (currentIndex >= currentText.length) { finishGame(); } 
            } else { 
                errors++; 
                triggerErrorShake(); 
            }
        }

        function updateDisplay() {
            if (!originalWords.length) originalWords = tokenizeText(currentText);
            let charCount = 0;
            let html = '';
            originalWords.forEach((token, index) => {
                const tokenLen = token.length;
                if (charCount + tokenLen <= currentIndex) {
                    html += `<span class="completed-text">${escapeHtml(token)}</span>`;
                } else {
                    if (charCount === currentIndex) { html += `<span class="cursor"></span>`; }
                    if (gameMode === 'quiz' && indicesToMask.has(index)) {
                        html += `<span class="solid-blank">${token}</span>`;
                    } else {
                        html += `<span class="remaining-text">${escapeHtml(token)}</span>`;
                    }
                }
                charCount += tokenLen;
            });
            verseDisplay.innerHTML = html;
            const percent = Math.floor((currentIndex / currentText.length) * 100);
            progressBar.style.width = `${percent}%`;
            progressIndicator.textContent = `${percent}%`;
        }

        function triggerErrorShake() {
            const card = document.getElementById('verse-display');
            card.classList.remove('error-shake');
            void card.offsetWidth; 
            card.classList.add('error-shake');
        }

        function finishGame() {
            isGameActive = false;
            hiddenInput.blur();
            updateStreak();
            let acc = 100;
            if (totalKeystrokes > 0) { const successfulHits = totalKeystrokes - errors; acc = Math.round((successfulHits / totalKeystrokes) * 100); }
            document.getElementById('accuracy-score').textContent = `${acc}%`;
            document.getElementById('error-count').textContent = errors;
            setTimeout(() => { gameScreen.classList.add('hidden'); resultScreen.classList.remove('hidden'); resultIcon.classList.add('pop-in'); }, 500);
        }
        
        function updateSettingsUI() {}

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        
        // Wait for DOM to be ready before starting init
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>